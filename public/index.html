<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP32 Pulse Monitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    /* ── TOKENS ─────────────────────────────────────────────── */
    :root {
      --bg:        #050c10;
      --surface:   #0a1820;
      --border:    #0d3040;
      --pulse:     #00e5ff;
      --pulse-dim: #004d66;
      --accent:    #ff6b35;
      --green:     #00ff88;
      --red:       #ff3355;
      --text:      #c8dce6;
      --text-dim:  #4a7085;
      --mono:      'Share Tech Mono', monospace;
      --sans:      'Rajdhani', sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Scanline overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg, transparent, transparent 2px,
        rgba(0,0,0,0.06) 2px, rgba(0,0,0,0.06) 4px
      );
      pointer-events: none;
      z-index: 999;
    }

    /* ── HEADER ─────────────────────────────────────────────── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 28px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, #070f17, #0a1820);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px; height: 36px;
      border: 2px solid var(--pulse);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .logo-icon svg { width: 22px; height: 22px; }

    .logo-text { font-size: 1.3rem; font-weight: 700; letter-spacing: 2px; color: var(--pulse); }
    .logo-sub  { font-family: var(--mono); font-size: 0.65rem; color: var(--text-dim); letter-spacing: 1px; }

    .conn-badge {
      display: flex; align-items: center; gap: 8px;
      font-family: var(--mono); font-size: 0.75rem;
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: rgba(0,229,255,0.04);
    }
    .conn-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--red);
      transition: background 0.3s;
    }
    .conn-dot.live { background: var(--green); box-shadow: 0 0 8px var(--green); animation: blink 1.4s infinite; }

    @keyframes blink { 0%,100%{ opacity:1; } 50%{ opacity:0.3; } }

    /* ── STATS ROW ──────────────────────────────────────────── */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 16px 28px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 18px;
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute; top: 0; left: 0;
      width: 3px; height: 100%;
      background: var(--pulse);
    }
    .stat-label { font-family: var(--mono); font-size: 0.65rem; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
    .stat-value { font-family: var(--mono); font-size: 1.6rem; color: var(--pulse); line-height: 1; }
    .stat-unit  { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; }

    /* ── MAIN GRID ──────────────────────────────────────────── */
    .main-grid {
      display: grid;
      grid-template-rows: auto auto;
      gap: 12px;
      padding: 0 28px 28px;
    }

    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,229,255,0.03);
    }
    .panel-title {
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--pulse);
      display: flex; align-items: center; gap: 8px;
    }
    .panel-title .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--pulse); box-shadow: 0 0 6px var(--pulse);
      animation: blink 1s infinite;
    }
    .panel-tag {
      font-family: var(--mono); font-size: 0.65rem;
      color: var(--text-dim); letter-spacing: 1px;
    }

    /* ── OSCILLOSCOPE ───────────────────────────────────────── */
    .scope-wrap {
      position: relative;
      padding: 12px 0;
      background: #030a0e;
    }

    /* Grid lines */
    .scope-wrap::before {
      content: '';
      position: absolute; inset: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 60px 40px;
      opacity: 0.5;
    }

    #scopeCanvas {
      display: block;
      width: 100%;
      height: 180px;
    }

    /* ── 10-MIN TABLE ───────────────────────────────────────── */
    .bucket-wrap {
      height: 300px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    .bucket-table {
      width: 100%;
      border-collapse: collapse;
      font-family: var(--mono);
      font-size: 0.75rem;
    }
    .bucket-table thead {
      position: sticky;
      top: 0;
      background: #0a1820;
      z-index: 1;
    }
    .bucket-table th {
      padding: 10px 18px;
      text-align: left;
      color: var(--text-dim);
      font-size: 0.65rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }
    .bucket-table th.right { text-align: right; }
    .bucket-table td {
      padding: 10px 18px;
      border-bottom: 1px solid rgba(13,48,64,0.4);
      color: var(--text);
      transition: background 0.15s;
    }
    .bucket-table tr:hover td { background: rgba(0,229,255,0.04); }
    .bucket-table tr:last-child td { border-bottom: none; }
    .bucket-count { font-size: 1rem; font-weight: bold; }
    .bucket-count.high { color: #00ff88; }
    .bucket-count.mid  { color: #00e5ff; }
    .bucket-count.low  { color: #ff6b35; }
    .bucket-count.zero { color: var(--text-dim); }
    .bucket-bar {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }
    .bucket-bar-fill {
      height: 100%;
      border-radius: 2px;
      background: var(--pulse);
      transition: width 0.4s ease;
    }
    .bucket-time { color: var(--text-dim); font-size: 0.65rem; }
    .bucket-date { color: var(--text); }

    /* ── PULSE LOG ──────────────────────────────────────────── */
    .log-wrap {
      height: 160px;
      overflow-y: auto;
      padding: 10px 18px;
      font-family: var(--mono);
      font-size: 0.72rem;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .log-line {
      display: flex; gap: 14px; align-items: center;
      padding: 3px 0;
      border-bottom: 1px solid rgba(13,48,64,0.4);
      animation: fadeIn 0.3s ease;
    }
    .log-line:last-child { border-bottom: none; }
    .log-time   { color: var(--text-dim); min-width: 90px; }
    .log-device { color: var(--accent); min-width: 100px; }
    .log-pulse  { color: var(--pulse); }

    @keyframes fadeIn { from { opacity:0; transform: translateY(-4px); } to { opacity:1; transform:none; } }

    /* ── TIME RANGE TABS ────────────────────────────────────── */
    .tabs { display: flex; gap: 6px; }
    .tab {
      font-family: var(--mono); font-size: 0.65rem;
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 1px;
    }
    .tab:hover, .tab.active {
      border-color: var(--pulse);
      color: var(--pulse);
      background: rgba(0,229,255,0.07);
    }

    /* ── NO DATA ─────────────────────────────────────────────── */
    .no-data {
      display: flex; align-items: center; justify-content: center;
      height: 100%;
      font-family: var(--mono); font-size: 0.75rem;
      color: var(--text-dim);
      letter-spacing: 2px;
    }

    /* ── RESPONSIVE ─────────────────────────────────────────── */
    @media (max-width: 768px) {
      .stats-row { grid-template-columns: repeat(2,1fr); }
      .panel-header { flex-wrap: wrap; gap: 8px; }
    }
    @media (max-width: 480px) {
      header { flex-direction: column; gap: 10px; }
      .stats-row { padding: 12px 14px; }
      .main-grid { padding: 0 14px 20px; }
    }
  </style>
</head>

<body>

<!-- ── HEADER ─────────────────────────────────────────────────── -->
<header>
  <div class="logo">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="#00e5ff" stroke-width="2" stroke-linecap="round">
        <polyline points="2,12 6,12 7,4 9,20 11,10 13,14 15,12 22,12"/>
      </svg>
    </div>
    <div>
      <div class="logo-text">PULSE MONITOR</div>
      <div class="logo-sub">ESP32 · GPIO 2 · 0.1 Hz</div>
    </div>
  </div>
  <div class="conn-badge">
    <div class="conn-dot" id="connDot"></div>
    <span id="connLabel">CONNECTING...</span>
  </div>
</header>

<!-- ── STATS ──────────────────────────────────────────────────── -->
<div class="stats-row">
  <div class="stat-card">
    <div class="stat-label">Total Pulses (5d)</div>
    <div class="stat-value" id="statTotal">—</div>
    <div class="stat-unit">pulses recorded</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Last 10 Min</div>
    <div class="stat-value" id="statLast10">—</div>
    <div class="stat-unit">pulses</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Last Pulse</div>
    <div class="stat-value" id="statLastTime" style="font-size:1rem;margin-top:6px">—</div>
    <div class="stat-unit">server time</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Expected Rate</div>
    <div class="stat-value">60</div>
    <div class="stat-unit">pulses / 10 min (0.1Hz)</div>
  </div>
</div>

<!-- ── MAIN ───────────────────────────────────────────────────── -->
<div class="main-grid">

  <!-- Oscilloscope -->
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title"><span class="dot"></span> LIVE WAVEFORM</div>
      <div class="panel-tag">LAST 10 MINUTES · AUTO-SCROLL</div>
    </div>
    <div class="scope-wrap">
      <canvas id="scopeCanvas"></canvas>
    </div>
  </div>

  <!-- 10-min count table -->
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">10-MIN PULSE COUNT</div>
      <div class="tabs">
        <button class="tab active" data-days="0.0417">1H</button>
        <button class="tab" data-days="0.25">6H</button>
        <button class="tab" data-days="1">1D</button>
        <button class="tab" data-days="5">5D</button>
      </div>
    </div>
    <div class="bucket-wrap">
      <table class="bucket-table">
        <thead>
          <tr>
            <th>#</th>
            <th>TIME INTERVAL</th>
            <th>PULSE COUNT (bar)</th>
            <th class="right">COUNT</th>
          </tr>
        </thead>
        <tbody id="bucketBody">
          <tr><td colspan="4" style="text-align:center;color:var(--text-dim);padding:30px;letter-spacing:2px;">NO DATA YET</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pulse log -->
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title"><span class="dot"></span> PULSE LOG</div>
      <div class="panel-tag">REAL-TIME EVENT STREAM</div>
    </div>
    <div class="log-wrap" id="logWrap">
      <div class="no-data">Waiting for pulses...</div>
    </div>
  </div>

</div>

<!-- ── SCRIPTS ─────────────────────────────────────────────────── -->
<script>
// ─── CONFIG ──────────────────────────────────────────────────────
const WS_URL = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws`;

// ─── STATE ───────────────────────────────────────────────────────
const waveformBuffer = []; // { time: ms, high: bool }[]
const WAVEFORM_WINDOW_MS = 10 * 60 * 1000; // 10 minutes
const MAX_LOG_LINES = 80;
let totalCount = 0;
let last10Count = 0;
let logLines = [];

// ─── OSCILLOSCOPE CANVAS ─────────────────────────────────────────
const scopeCanvas = document.getElementById('scopeCanvas');
const ctx = scopeCanvas.getContext('2d');

function resizeScope() {
  scopeCanvas.width  = scopeCanvas.offsetWidth  * devicePixelRatio;
  scopeCanvas.height = scopeCanvas.offsetHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
}
window.addEventListener('resize', () => { resizeScope(); drawScope(); });
resizeScope();

function drawScope() {
  const W = scopeCanvas.offsetWidth;
  const H = scopeCanvas.offsetHeight;
  ctx.clearRect(0, 0, W, H);

  const now = Date.now();
  const start = now - WAVEFORM_WINDOW_MS;

  // Filter pulses in window
  const inWindow = waveformBuffer.filter(p => p >= start);

  if (inWindow.length === 0) {
    // Flat LOW line
    ctx.strokeStyle = '#004d66';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, H * 0.75);
    ctx.lineTo(W, H * 0.75);
    ctx.stroke();
    return;
  }

  const PULSE_WIDTH_MS = 500; // how wide each pulse appears (visual)
  const HIGH_Y = H * 0.2;
  const LOW_Y  = H * 0.75;

  ctx.save();

  // Glow layer
  ctx.shadowColor = '#00e5ff';
  ctx.shadowBlur  = 10;
  ctx.strokeStyle = '#00e5ff';
  ctx.lineWidth   = 2;
  ctx.beginPath();

  let prevX = 0;
  let inPulse = false;

  // Build segments
  // We draw: LOW → at each pulse time, shoot UP, hold for PULSE_WIDTH_MS, back LOW
  const timeToX = (t) => ((t - start) / WAVEFORM_WINDOW_MS) * W;

  ctx.moveTo(0, LOW_Y);

  for (let i = 0; i < inWindow.length; i++) {
    const pt = inWindow[i];
    const px = timeToX(pt);
    const px2 = timeToX(pt + PULSE_WIDTH_MS);

    // Draw LOW up to pulse
    ctx.lineTo(px, LOW_Y);
    // Rising edge
    ctx.lineTo(px, HIGH_Y);
    // Hold HIGH for pulse width
    ctx.lineTo(Math.min(px2, W), HIGH_Y);
    // Falling edge (if still in window)
    if (px2 <= W) {
      ctx.lineTo(px2, LOW_Y);
    }
  }

  // Draw LOW to end
  const lastPulse = inWindow[inWindow.length - 1];
  const lastFallX = timeToX(lastPulse + PULSE_WIDTH_MS);
  if (lastFallX < W) {
    ctx.lineTo(W, LOW_Y);
  }

  ctx.stroke();

  // Dim glow fill under waveform
  ctx.shadowBlur = 0;
  ctx.strokeStyle = 'transparent';
  ctx.lineTo(W, LOW_Y);
  ctx.lineTo(0, LOW_Y);
  ctx.closePath();
  ctx.fillStyle = 'rgba(0,229,255,0.04)';
  ctx.fill();

  // Pulse markers (dots at top)
  ctx.shadowColor = '#00e5ff';
  ctx.shadowBlur  = 14;
  ctx.fillStyle   = '#00e5ff';
  inWindow.forEach(pt => {
    const px = timeToX(pt);
    if (px >= 0 && px <= W) {
      ctx.beginPath();
      ctx.arc(px, HIGH_Y, 4, 0, Math.PI * 2);
      ctx.fill();
    }
  });

  // Time axis labels
  ctx.restore();
  ctx.fillStyle = '#4a7085';
  ctx.font = `10px 'Share Tech Mono'`;
  ctx.textAlign = 'center';
  for (let m = 0; m <= 10; m += 2) {
    const x = (m / 10) * W;
    const label = m === 10 ? 'NOW' : `-${10 - m}m`;
    ctx.fillText(label, x, H - 4);
  }

  // Labels: HIGH / LOW
  ctx.textAlign = 'left';
  ctx.fillStyle = '#4a7085';
  ctx.fillText('HIGH', 4, HIGH_Y - 6);
  ctx.fillText('LOW', 4, LOW_Y - 6);
}

// Redraw scope 60fps
setInterval(drawScope, 1000 / 30);

// ─── 10-MIN COUNT TABLE ──────────────────────────────────────────
let barDays = 0.0417;

function colorClass(count, max) {
  if (count === 0)          return 'zero';
  if (count >= max * 0.75)  return 'high';
  if (count >= max * 0.4)   return 'mid';
  return 'low';
}

function formatInterval(ms) {
  const start = new Date(ms);
  const end   = new Date(ms + 600000);
  const today = new Date().toDateString();
  const dateStr = start.toDateString() === today
    ? ''
    : `<span class="bucket-date">${start.toLocaleDateString([], {month:'short', day:'numeric'})} </span>`;
  const timeStr = `<span class="bucket-time">${start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} → ${end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
  return dateStr + timeStr;
}

async function loadBuckets() {
  try {
    const res     = await fetch(`/api/buckets?days=${barDays}`);
    const data    = await res.json();
    const buckets = (data.buckets || []).reverse(); // newest first
    const max     = Math.max(...buckets.map(b => b.count), 1);
    const tbody   = document.getElementById('bucketBody');

    if (buckets.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--text-dim);padding:30px;letter-spacing:2px;">NO DATA YET</td></tr>`;
      return;
    }

    tbody.innerHTML = buckets.map((b, i) => {
      const pct   = Math.round((b.count / max) * 100);
      const cls   = colorClass(b.count, max);
      return `
        <tr>
          <td style="color:var(--text-dim)">${buckets.length - i}</td>
          <td>${formatInterval(b.bucket_ms)}</td>
          <td>
            <div class="bucket-bar">
              <div class="bucket-bar-fill" style="width:${pct}%"></div>
            </div>
          </td>
          <td style="text-align:right">
            <span class="bucket-count ${cls}">${b.count}</span>
          </td>
        </tr>`;
    }).join('');

    // Update last-10-min stat card
    if (buckets[0]) {
      document.getElementById('statLast10').textContent = buckets[0].count;
    }
  } catch(e) {
    console.error('Bucket load error:', e);
  }
}

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    barDays = parseFloat(tab.dataset.days);
    loadBuckets();
  });
});

// Refresh bar chart every 60 seconds
setInterval(loadBuckets, 60000);
setInterval(loadStats, 60000);

// ─── PULSE LOG ───────────────────────────────────────────────────
function addLogLine(pulse) {
  const t   = new Date(pulse.server_time || Date.now());
  const ts  = t.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  logLines.unshift({ ts, device: pulse.device_id || 'ESP32-001', num: pulse.pulse_number || '?' });
  if (logLines.length > MAX_LOG_LINES) logLines.pop();

  const wrap = document.getElementById('logWrap');
  wrap.innerHTML = logLines.map(l => `
    <div class="log-line">
      <span class="log-time">${l.ts}</span>
      <span class="log-device">${l.device}</span>
      <span class="log-pulse">▲ PULSE #${l.num}</span>
    </div>
  `).join('');
}

// ─── STATS ────────────────────────────────────────────────────────
function updateStats() {
  document.getElementById('statTotal').textContent = totalCount;
}

async function loadStats() {
  try {
    const res  = await fetch('/api/stats');
    const data = await res.json();
    totalCount = data.total_pulses || 0;
    updateStats();
    if (data.last_ms) {
      const d = new Date(data.last_ms);
      document.getElementById('statLastTime').textContent =
        d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }
  } catch(e) {}
}

// ─── WEBSOCKET ────────────────────────────────────────────────────
const connDot   = document.getElementById('connDot');
const connLabel = document.getElementById('connLabel');
let ws, reconnectTimer;

function connect() {
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    connDot.classList.add('live');
    connLabel.textContent = 'LIVE';
    clearTimeout(reconnectTimer);
  };

  ws.onclose = ws.onerror = () => {
    connDot.classList.remove('live');
    connLabel.textContent = 'RECONNECTING...';
    reconnectTimer = setTimeout(connect, 3000);
  };

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === 'HISTORY') {
      // Populate waveform buffer from history
      waveformBuffer.length = 0;
      msg.pulses.forEach(p => waveformBuffer.push(p.server_time));
      drawScope();
      // Build log from history
      const sorted = [...msg.pulses].sort((a,b) => b.server_time - a.server_time);
      sorted.slice(0, 20).forEach(p => addLogLine(p));
      loadStats();
    }

    if (msg.type === 'PULSE') {
      const p = msg.pulse;
      // Add to waveform buffer
      waveformBuffer.push(p.server_time);
      // Trim old pulses outside window
      const cutoff = Date.now() - WAVEFORM_WINDOW_MS;
      while (waveformBuffer.length > 0 && waveformBuffer[0] < cutoff) {
        waveformBuffer.shift();
      }

      // Update counters
      totalCount++;
      updateStats();

      // Update last pulse time
      const d = new Date(p.server_time);
      document.getElementById('statLastTime').textContent =
        d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});

      // Log entry
      addLogLine(p);

      // Flash title
      document.title = `⚡ PULSE #${p.pulse_number} — ESP32 Monitor`;
      setTimeout(() => { document.title = 'ESP32 Pulse Monitor'; }, 1000);
    }
  };
}

// ─── INIT ─────────────────────────────────────────────────────────
loadStats();
loadBuckets();
connect();
</script>
</body>
</html>
